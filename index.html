<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>도둑이 탄 칸을 맞춰라!</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background-color: #f8f8f8;
    }

    .train-wrapper {
      position: relative;
      width: 90vw;
      max-width: 900px;
      margin: 20px auto;
    }

    .train-img {
      width: 100%;
      display: block;
    }

    .train-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      transform: translate(100px, 45px);
    }

    .car {
      position: absolute;
      width: 12%;
      min-width: 60px;
      padding: 8px;
      border: 2px solid #333;
      border-radius: 10px;
      background-color: white;
      text-align: center;
      font-size: 0.9rem;
      pointer-events: auto;
      cursor: pointer;
      z-index: 5;
      transition: transform 0.3s ease, background-color 0.3s ease;
    }

    .car.correct-animate {
      animation: correctPop 0.6s ease forwards;
    }

    @keyframes correctPop {
      0% { transform: scale(1); background-color: white; }
      50% { transform: scale(1.2); background-color: lightgreen; }
      100% { transform: scale(1); background-color: white; }
    }

    .debug-box {
      position: absolute;
      width: 12%;
      height: 25%;
      background-color: rgba(0, 128, 255, 0.2);
      border: 1px dashed #0077cc;
      z-index: 1;
    }

    .selectors {
      margin: 15px;
    }

    select, button {
      padding: 6px;
      font-size: 1rem;
      margin: 4px;
    }

    #timerDisplay {
      font-size: 1.1rem;
      font-weight: bold;
      margin: 10px 0;
    }

    .cannon-container {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      position: relative;
      height: auto;
      padding: 20px;
      gap: 20px;
    }

    .cannon {
      width: 20vw;
      max-width: 200px;
    }

    #question-img {
      width: 20vw;
      max-width: 100px;
    }

    .bomb {
      width: 70px;
      position: absolute;
      display: none;
      transition: all 1s ease-in-out;
      z-index: 10;
    }

    .speech-bubble {
      position: absolute;
      background: #fff;
      border: 2px solid #333;
      padding: 10px;
      border-radius: 10px;
      display: none;
      z-index: 20;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <h1>도둑이 탄 칸을 맞춰라!</h1>
  <h2 style="font-size: 1rem;">도둑이 보물을 훔쳐 달아났다. 단어를 맞춰 도둑이 탄 기차칸에 폭탄을 던지자!</h2>

  <div class="selectors">
    <select id="unitSelector">
      <option value="word_list_unit1.csv">Unit 1</option>
      <option value="word_list_unit2.csv">Unit 2</option>
      <option value="word_list_unit3.csv">Unit 3</option>
    </select>
    <select id="levelSelector">
      <option value="60">Level 1 (60초)</option>
      <option value="100">Level 2 (100초)</option>
      <option value="150">Level 3 (150초)</option>
    </select>
    <button onclick="loadSelectedCSV()">불러오기</button>
    <button onclick="toggleDebug()">debug-box 토글</button>
  </div>

  <div style="margin: 10px;">
    <label for="xOffset">가로 위치:</label>
    <input type="range" id="xOffset" min="-100" max="100" value="0">
    <span id="xValue">0</span>px
    <label for="yOffset" style="margin-left: 20px;">세로 위치:</label>
    <input type="range" id="yOffset" min="-100" max="100" value="0">
    <span id="yValue">0</span>px
  </div>

  <div id="timerDisplay">제한 시간: 0초</div>

  <div class="train-wrapper">
    <img src="images/train_bg.png" class="train-img" />
    <div class="train-overlay" id="train">
      <div class="debug-box" style="left:20%; top:28%;"></div>
      <div class="debug-box" style="left:40%; top:28%;"></div>
      <div class="debug-box" style="left:60%; top:28%;"></div>
      <div class="debug-box" style="left:80%; top:28%;"></div>
    </div>
  </div>

  <div class="cannon-container">
    <img src="images/cannon.png" class="cannon" />
    <img id="question-img" src="" />
    <img id="bomb" class="bomb" src="images/cutebomb.png" />
    <div id="speech" class="speech-bubble"></div>
  </div>

  <script>
    let data = [], score = 0, tries = 0;
    let startTime, timer, timeLimit = 60;
    let usedIndexes = [];

    const trainDiv = document.getElementById("train");
    const bomb = document.getElementById("bomb");
    const questionImg = document.getElementById("question-img");
    const speech = document.getElementById("speech");

    function shuffle(array) {
      return array.sort(() => Math.random() - 0.5);
    }

    function parseCSV(text) {
      return text.trim().split("\n").map(row => {
        const [word, img] = row.split(",");
        return { word, img };
      });
    }

    function loadSelectedCSV() {
      const fileName = unitSelector.value;
      timeLimit = parseInt(levelSelector.value);
      document.getElementById("timerDisplay").innerText = `제한 시간: ${timeLimit}초`;

      fetch(fileName)
        .then(res => res.text())
        .then(text => {
          data = parseCSV(text);
          usedIndexes = [];
          score = 0;
          tries = 0;
          clearInterval(timer);
          startTime = Date.now();
          startTimer();
          nextQuestion();
        })
        .catch(() => alert("CSV 파일을 불러올 수 없습니다."));
    }

    function startTimer() {
      timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = timeLimit - elapsed;
        document.getElementById("timerDisplay").innerText = `남은 시간: ${remaining}초`;
        if (remaining <= 0) {
          clearInterval(timer);
          alert(`시간 종료! ${score}/10명의 도둑을 잡았어!`);
        }
      }, 1000);
    }

    function getRandomUnusedIndex() {
      if (usedIndexes.length >= 10 || usedIndexes.length >= data.length) return null;
      let idx;
      do {
        idx = Math.floor(Math.random() * data.length);
      } while (usedIndexes.includes(idx));
      usedIndexes.push(idx);
      return idx;
    }

    function nextQuestion() {
      const randIndex = getRandomUnusedIndex();
      if (randIndex === null) {
        clearInterval(timer);
        const timeSpent = Math.floor((Date.now() - startTime) / 1000);
        alert(`Great! ${timeSpent}초 만에 ${score}/${usedIndexes.length}명의 도둑을 잡았어!`);
        return;
      }

      tries = 0;
      const correct = data[randIndex];
      const options = shuffle([correct, ...shuffle(data.filter(d => d !== correct)).slice(0, 3)]);

      trainDiv.querySelectorAll('.car').forEach(el => el.remove());

      const carPositions = ["20%", "40%", "60%", "80%"];
      options.forEach((opt, i) => {
        const car = document.createElement("div");
        car.className = "car";
        car.innerText = opt.word;
        car.style.left = carPositions[i];
        car.style.top = "28%";
        car.onclick = () => checkAnswer(opt.word, correct.word, car);
        trainDiv.appendChild(car);
      });

      questionImg.src = correct.img;
    }

    function checkAnswer(selected, correct, carElement) {
      const cannon = document.querySelector(".cannon");
      const cannonRect = cannon.getBoundingClientRect();
      const carRect = carElement.getBoundingClientRect();

      const scrollY = window.scrollY;
      const scrollX = window.scrollX;

      const cannonStartX = cannonRect.left + cannonRect.width / 2 - 20 + scrollX;
      const cannonStartY = cannonRect.top - 10 + scrollY;

      const targetX = carRect.left + carRect.width / 2 - 20 + scrollX;
      const targetY = carRect.top + carRect.height / 2 - 20 + scrollY;

      bomb.style.left = `${cannonStartX}px`;
      bomb.style.top = `${cannonStartY}px`;
      bomb.style.display = "block";

      setTimeout(() => {
        bomb.style.left = `${targetX}px`;
        bomb.style.top = `${targetY}px`;

        setTimeout(() => {
          speech.style.left = `${carRect.left + scrollX}px`;
          speech.style.top = `${carRect.top + scrollY - 40}px`;

          if (selected === correct) {
            score++;
            speech.innerText = "Great!";
            carElement.classList.add("correct-animate");
          } else {
            tries++;
            speech.innerText = tries >= 3 ? "기회를 모두 썼어요!" : `틀렸어요! (${3 - tries}번 남음)`;
          }

          speech.style.display = "block";

          setTimeout(() => {
            speech.style.display = "none";
            bomb.style.display = "none";
            if (selected === correct || tries >= 3) nextQuestion();
          }, 1000);
        }, 800);
      }, 100);
    }

    function toggleDebug() {
      document.querySelectorAll('.debug-box').forEach(box => {
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
      });
    }

    const xSlider = document.getElementById("xOffset");
    const ySlider = document.getElementById("yOffset");
    const xValue = document.getElementById("xValue");
    const yValue = document.getElementById("yValue");
    const trainOverlay = document.querySelector(".train-overlay");

    function updateOffset() {
      const x = parseInt(xSlider.value);
      const y = parseInt(ySlider.value);
      xValue.textContent = x;
      yValue.textContent = y;
      trainOverlay.style.transform = `translate(${x}px, ${y}px)`;
    }

    xSlider.addEventListener("input", updateOffset);
    ySlider.addEventListener("input", updateOffset);
  </script>
</body>
</html>
